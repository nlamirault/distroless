# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Reusable release workflow

on: # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      repository:
        description: "Image repository"
        type: string
        required: false
        # default: nlamirault/distroless/${{ github.workflow }}
      tag:
        description: "Image tag"
        type: string
        required: false
        default: "latest"
      config-dir:
        description: "Config directory"
        type: string
        required: false
        # default: images/${{ github.workflow }}
      target:
        description: "Image target"
        type: string
        required: false
        default: "prod"
      archs:
        description: "Architectures"
        type: string
        required: false
        default: "amd64,arm64"
      scan:
        description: "Enable scan"
        type: string
        required: false
        default: "true"

env:
  REGISTRY: ghcr.io

jobs:
  publish:
    permissions:
      actions: read
      attestations: write
      contents: read
      id-token: write
      packages: write
      security-events: write

    runs-on: ubuntu-latest

    outputs:
      digest: ${{ steps.digest.outputs.digest }}
      registry: ${{ steps.vars.outputs.registry }}
      image: ${{ steps.vars.outputs.image }}

    steps:
    - name: ğŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: ğŸ‰ Setup Crane
      uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

    - name: ğŸ‰ Install cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
    # with:
    #   cosign-release: 2.6.1

    - name: ğŸ’¡ Set Vars
      id: vars
      shell: bash
      run: |
        if [[ "${{ github.ref_name }}" != "main" ]]; then
          # export REGISTRY="ttl.sh"
          export REGISTRY=${{ env.REGISTRY }}
        else
          export REGISTRY=${{ env.REGISTRY }}
        fi
        echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT
        echo "image=${REGISTRY}/${{ inputs.repository }}:${{ inputs.tag }}" >> $GITHUB_OUTPUT
        # Debug
        echo "registry=${REGISTRY}"
        echo "image=${REGISTRY}/${{ inputs.repository }}:${{ inputs.tag }}"

    - if: steps.vars.outputs.registry == 'ghcr.io'
      name: ğŸ”“ Login to GitHub Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Create SBOM directory
      id: output
      shell: bash
      run: |
        mkdir -p ${{ github.workspace }}/sbom

    - name: ğŸ”§ Check for melange.yaml
      id: check-melange
      shell: bash
      run: |
        if [ -f "${{ inputs.config-dir }}/melange.yaml" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - if: steps.check-melange.outputs.exists == 'true'
      name: âœ… Melange
      uses: chainguard-dev/actions/melange-build@3e8a2a226fad9e1ecbf2d359b8a7697554a4ac6d # v1.5.10
      with:
        config: ${{ inputs.config-dir }}/melange.yaml
        archs: ${{ inputs.archs }}
        signing-key-path: ${{ github.workspace }}/keys/melange.rsa
        repository-path: ${{ github.workspace }}/packages
        empty-workspace: false
        sign-with-temporary-key: true

    - if: steps.check-melange.outputs.exists == 'true'
      name: âœ… Apko and Melange
      id: apko-melange
      uses: chainguard-images/actions/apko-publish@e5595253fa40415ea0c8ac3ff791b52eacbfd393 # v1.0.10
      with:
        config: ${{ inputs.config-dir }}/${{ inputs.target }}.yaml
        keyring-append: ${{ github.workspace }}/keys/melange.rsa.pub
        build-repository-append: ${{ github.workspace }}/packages
        tag: ${{ steps.vars.outputs.image }}
        archs: ${{ inputs.archs }}
        sbom-path: ${{ github.workspace }}/sbom

    - if: steps.check-melange.outputs.exists == 'false'
      name: âœ… Apko
      id: apko
      uses: chainguard-images/actions/apko-publish@e5595253fa40415ea0c8ac3ff791b52eacbfd393 # v1.0.10
      with:
        config: ${{ inputs.config-dir }}/${{ inputs.target }}.yaml
        tag: ${{ steps.vars.outputs.image }}
        archs: ${{ inputs.archs }}
        sbom-path: ${{ github.workspace }}/sbom

    - name: ğŸ”§ Extract digest
      id: digest
      shell: bash
      run: |
        echo "digest=$(crane digest ${{ steps.vars.outputs.image }})" >> $GITHUB_OUTPUT
        crane digest ${{ steps.vars.outputs.image }}

        if [[ "${{ inputs.archs }}" == *"amd64"* ]]; then
            echo "digest-amd64=$(crane digest --platform=linux/amd64 ${{ steps.vars.outputs.image }})" >> $GITHUB_OUTPUT
            crane digest --platform=linux/amd64 ${{ steps.vars.outputs.image }}
        else
            echo "AMD64 unavailable"
            echo "digest-amd64=''" >> $GITHUB_OUTPUT
        fi
        if [[ "${{ inputs.archs }}" == *"arm64"* ]]; then
            echo "digest-arm64=$(crane digest --platform=linux/arm64 ${{ steps.vars.outputs.image }})" >> $GITHUB_OUTPUT
            crane digest --platform=linux/arm64 ${{ steps.vars.outputs.image }}
        else
            echo "ARM64 unavailable"
            echo "digest-arm64=''" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”“ Sign image
      shell: bash
      env:
        COSIGN_YES: "true"
      run: |
        cosign sign \
          --recursive \
          --use-signing-config=false \
          --oidc-provider=github-actions \
          --oidc-issuer=https://token.actions.githubusercontent.com \
          ${{ steps.vars.outputs.image }}

    - name: ğŸ”“ Attest index SBOM
      shell: bash
      env:
        COSIGN_YES: "true"
      run: |
        cosign attest \
          --type=spdxjson \
          --use-signing-config=false \
          --predicate=${{ github.workspace }}/sbom/sbom-index.spdx.json \
          --oidc-provider=github-actions \
          ${{ steps.vars.outputs.registry }}/${{ inputs.repository }}@${{ steps.digest.outputs.digest }}

    - if: steps.digest.outputs.digest-amd64 != ''
      name: ğŸ”“ Attest amd64 SBOM
      shell: bash
      env:
        COSIGN_YES: "true"
      run: |
        cosign attest \
          --type=spdxjson \
          --use-signing-config=false \
          --predicate=${{ github.workspace }}/sbom/sbom-x86_64.spdx.json \
          --oidc-provider=github-actions \
          ${{ steps.vars.outputs.registry }}/${{ inputs.repository }}@${{ steps.digest.outputs.digest-amd64 }}

    - if: steps.digest.outputs.digest-arm64 != ''
      name: ğŸ”“ Attest arm64 SBOM
      shell: bash
      env:
        COSIGN_YES: "true"
      run: |
        cosign attest \
          --type=spdxjson \
          --use-signing-config=false \
          --predicate=${{ github.workspace }}/sbom/sbom-aarch64.spdx.json \
          --oidc-provider=github-actions \
          ${{ steps.vars.outputs.registry }}/${{ inputs.repository }}@${{ steps.digest.outputs.digest-arm64 }}

    - if: steps.vars.outputs.registry == 'ghcr.io'
      name: ğŸ”“ Attest build provenance
      uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
      with:
        subject-name: ${{ steps.vars.outputs.registry }}/${{ inputs.repository }}
        subject-digest: ${{ steps.digest.outputs.digest }}
        push-to-registry: true

  slsa:
    permissions:
      actions: read
      id-token: write
      packages: write
    needs: publish
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.publish.outputs.image }}
      digest: ${{ needs.publish.outputs.digest }}
    secrets:
      registry-username: ${{ github.actor }}
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  scan:
    if: inputs.scan == 'true'
    permissions:
      actions: read
      contents: read
      packages: read
      security-events: write
    needs: publish
    runs-on: ubuntu-latest
    steps:
    - name: ğŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: âœ… Scan image
      id: scan
      uses: anchore/scan-action@3c9a191a0fbab285ca6b8530b5de5a642cba332f # v7.2.2
      with:
        image: ${{ needs.publish.outputs.image }}
        cache-db: true
        fail-build: "false"
        severity-cutoff: "high"
        output-format: "sarif"

    - name: â¬†ï¸ Upload SARIF
      uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}
        category: ${{ github.workflow }}
